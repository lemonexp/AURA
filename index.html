<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura v2 - Modern AI Chat</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: { 750: '#2d3748', 850: '#1a202c', 900: '#111827', 950: '#030712' },
                        aura: { 500: '#8b5cf6', 600: '#7c3aed' }, // Violet brand
                        accent: { 500: '#06b6d4', 600: '#0891b2' } // Cyan accent
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Lexend Deca', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'scale-in': 'scaleIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        scaleIn: { '0%': { transform: 'scale(0.95)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                    }
                }
            }
        }
    </script>
    
    <!-- Marked for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- KaTeX for Math -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #030712; color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Lexend Deca', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Markdown Overrides */
        .prose p { margin-bottom: 0.75em; line-height: 1.6; }
        .prose pre { margin: 0.5em 0; border-radius: 0.5rem; background: #1f2937; padding: 1em; overflow-x: auto; border: 1px solid #374151; }
        .prose code { font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.1); padding: 0.1em 0.3em; border-radius: 0.25em; font-size: 0.9em; }
        .prose pre code { background: transparent; padding: 0; border: none; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose blockquote { border-left: 3px solid #8b5cf6; padding-left: 1em; font-style: italic; color: #9ca3af; margin: 1em 0; background: rgba(139, 92, 246, 0.05); padding-y: 0.5em; border-radius: 0 0.5rem 0.5rem 0; }
        .prose a { color: #a78bfa; text-decoration: none; border-bottom: 1px dotted #a78bfa; transition: color 0.2s; }
        .prose a:hover { color: #c4b5fd; border-bottom-style: solid; }
        .prose table { width: 100%; border-collapse: collapse; margin: 1em 0; }
        .prose th, .prose td { border: 1px solid #374151; padding: 0.5em; text-align: left; }
        .prose th { background: #1f2937; }

        /* Explicit Header Sizing for AI Responses */
        .prose h1 { font-size: 2.25rem; font-weight: 700; margin-top: 1.2em; margin-bottom: 0.6em; color: #f3f4f6; letter-spacing: -0.025em; }
        .prose h2 { font-size: 1.875rem; font-weight: 700; margin-top: 1.2em; margin-bottom: 0.6em; color: #e5e7eb; letter-spacing: -0.025em; }
        .prose h3 { font-size: 1.5rem; font-weight: 600; margin-top: 1.1em; margin-bottom: 0.5em; color: #d1d5db; }
        .prose h4 { font-size: 1.25rem; font-weight: 600; margin-top: 1em; margin-bottom: 0.5em; color: #9ca3af; }
        .prose strong { color: #fff; font-weight: 700; }
        .prose em { color: #e5e7eb; font-style: italic; }
        
        /* Glassmorphism Utilities */
        .glass-panel { background: rgba(17, 24, 39, 0.75); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-input { background: rgba(3, 7, 18, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-top: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-button { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.2s; }
        .glass-button:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.1); }
        
        /* Mobile Optimizations */
        @media (max-width: 640px) {
            .mobile-hide-scrollbar::-webkit-scrollbar { display: none; }
            .mobile-hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect, useMemo } = React;

        // --- Icons (Inline SVGs) ---
        const Icons = {
            Send: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Paperclip: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>,
            Menu: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="18" x2="20" y2="18"/></svg>,
            Plus: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Download: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Lock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Zap: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Cpu: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><path d="M9 1v3"/><path d="M15 1v3"/><path d="M9 20v3"/><path d="M15 20v3"/><path d="M20 9h3"/><path d="M20 15h3"/><path d="M1 9h3"/><path d="M1 15h3"/></svg>,
            ShieldAlert: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            ChevronDown: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m6 9 6 6 6-6"/></svg>,
            Image: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            Video: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            Wrench: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            Eye: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Coffee: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" x2="6" y1="1" y2="4"/><line x1="10" x2="10" y1="1" y2="4"/><line x1="14" x2="14" y1="1" y2="4"/></svg>,
        };

        // --- Config & Prompt ---
        // UPDATED: System Prompt with specific formatting rules
        const DEFAULT_SYSTEM_PROMPT = `
You are Aura. Model: Aura 2.0 Modern.
Creators: TidalVoid, lemonexp, kosmos.
Tone: Helpful, witty, smart. Roast if the user is being silly.
Capabilities: Math, Code, Analysis, Image Vision.
Formatting Requirements:
- STRUCTURE: Use Markdown.
- MATH: Always use $$ ... $$ for block math (centered) and $ ... $ for inline math.
- HEADINGS: Use ### for Main Headings (Large) and #### for Subheadings (Medium).
- EMPHASIS: Use **bold** for important terms and *italic* for subtle emphasis.
`;
        const DEV_MODE_PASSKEY = "zoinkvoid70kimjongunramdoesstuff!";
        
        // Model Configuration
        const MODELS = {
            swift: { id: 'swift', name: 'Aura Swift', apiModel: 'gemini-2.5-flash-lite', desc: 'Fast', icon: Icons.Zap },
            nexus: { id: 'nexus', name: 'Aura Nexus', apiModel: 'gemini-3-flash-preview', desc: 'Capable', icon: Icons.Cpu },
        };

        // --- Components ---
        
        const Icon = ({ icon: IconComponent, size = 20, className }) => {
            if (!IconComponent) return null;
            return <IconComponent width={size} height={size} className={className} />;
        };

        const MarkdownRenderer = ({ content, isCollapsedDefault = false }) => {
            const containerRef = useRef(null);
            const [collapsed, setCollapsed] = useState(isCollapsedDefault);
            const [isLong, setIsLong] = useState(false);

            useEffect(() => {
                if (content && content.length > 800) setIsLong(true);
            }, [content]);

            useEffect(() => {
                if (containerRef.current && content) {
                    try {
                        const rawHtml = marked.parse(String(content));
                        containerRef.current.innerHTML = rawHtml;
                        if (window.renderMathInElement) {
                            renderMathInElement(containerRef.current, {
                                delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}],
                                throwOnError: false
                            });
                        }
                    } catch (e) {
                        containerRef.current.innerText = content;
                    }
                }
            }, [content]);

            return (
                <div className="relative">
                    <div 
                        ref={containerRef} 
                        className={`prose prose-invert max-w-none text-sm sm:text-base leading-relaxed break-words ${collapsed && isLong ? 'max-h-48 overflow-hidden mask-gradient-b' : ''}`} 
                    />
                    {isLong && (
                        <button 
                            onClick={() => setCollapsed(!collapsed)}
                            className="text-xs text-aura-400 hover:text-aura-300 mt-2 flex items-center gap-1 font-medium transition-colors"
                        >
                            {collapsed ? 'Show more' : 'Show less'} <Icon icon={Icons.ChevronDown} size={12} className={`transform transition-transform ${collapsed ? '' : 'rotate-180'}`} />
                        </button>
                    )}
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md animate-fade-in">
                    <div className="glass-panel bg-[#0f172a] rounded-2xl w-full max-w-md p-6 shadow-2xl relative max-h-[90vh] flex flex-col transform transition-all duration-300 border border-white/10">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                            <Icon icon={Icons.X} />
                        </button>
                        <h2 className="text-xl font-bold mb-4 text-aura-500 font-display flex-shrink-0">{title}</h2>
                        <div className="overflow-y-auto flex-1 custom-scrollbar pr-2">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---

        const App = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [currentModel, setCurrentModel] = useState('swift');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [storageMode, setStorageMode] = useState('local');
            const [userName, setUserName] = useState(localStorage.getItem('aura_username') || '');
            const [savedChats, setSavedChats] = useState([]);
            const [uploadedFile, setUploadedFile] = useState(null);
            const [currentChatId, setCurrentChatId] = useState(Date.now().toString());
            const [showCoffee, setShowCoffee] = useState(true); 
            
            // Dev Mode
            const [devMode, setDevMode] = useState(false);
            const [systemPrompt, setSystemPrompt] = useState(DEFAULT_SYSTEM_PROMPT);
            const [passkeyInput, setPasskeyInput] = useState('');
            
            // UI States
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [showPasskeyModal, setShowPasskeyModal] = useState(false);
            const [imageModalSrc, setImageModalSrc] = useState(null);
            const [fileContentModal, setFileContentModal] = useState(null); 

            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            // --- Init ---
            useEffect(() => {
                const storedChats = localStorage.getItem('aura_saved_chats');
                if (storedChats) setSavedChats(JSON.parse(storedChats));

                const storedKey = localStorage.getItem('aura_api_key');
                const storedMode = localStorage.getItem('aura_storage_mode');
                
                if (storedMode === 'local' && storedKey) {
                    setApiKey(storedKey);
                    setStorageMode('local');
                } else {
                    setShowSettingsModal(true);
                }
            }, []);

            // Save messages to current chat whenever they change
            useEffect(() => {
                if (messages.length > 0) {
                    setSavedChats(prev => {
                        const existingIndex = prev.findIndex(c => c.id === currentChatId);
                        const chatName = messages[0].text.substring(0, 30) || "New Chat";
                        
                        const updatedChat = {
                            id: currentChatId,
                            name: chatName,
                            messages: messages,
                            timestamp: Date.now(),
                            model: currentModel
                        };

                        if (existingIndex >= 0) {
                            const newChats = [...prev];
                            newChats[existingIndex] = updatedChat;
                            return newChats;
                        } else {
                            return [updatedChat, ...prev];
                        }
                    });
                }
            }, [messages, currentChatId]); 

            useEffect(() => {
                if (storageMode === 'local') {
                    localStorage.setItem('aura_api_key', apiKey);
                    localStorage.setItem('aura_storage_mode', 'local');
                } else if (storageMode === 'session') {
                    localStorage.removeItem('aura_api_key');
                    localStorage.removeItem('aura_storage_mode');
                }
            }, [apiKey, storageMode]);

            useEffect(() => { localStorage.setItem('aura_username', userName); }, [userName]);
            useEffect(() => { localStorage.setItem('aura_saved_chats', JSON.stringify(savedChats)); }, [savedChats]);
            useLayoutEffect(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages, isLoading]);

            // --- Handlers ---

            const startNewChat = () => {
                setMessages([]);
                setCurrentChatId(Date.now().toString()); 
                setSidebarOpen(false);
            };

            const loadChat = (chat) => {
                setMessages(chat.messages);
                setCurrentChatId(chat.id); 
                setCurrentModel(chat.model || 'swift');
                setSidebarOpen(false);
            };

            const toggleDevMode = () => {
                if (devMode) {
                    setDevMode(false);
                } else {
                    setPasskeyInput('');
                    setShowPasskeyModal(true);
                }
            };

            const submitPasskey = () => {
                if (passkeyInput === DEV_MODE_PASSKEY) {
                    setDevMode(true);
                    setShowPasskeyModal(false);
                    setShowSettingsModal(true); 
                } else {
                    alert("Incorrect Passkey. Access Denied.");
                }
            };

            const handleSendMessage = async (customText = null) => {
                if (isLoading) return; // Prevent double sending

                const textToSend = customText || input;
                if (!textToSend.trim() && !uploadedFile) return;
                if (!apiKey) { setShowSettingsModal(true); return; }

                // Injection Guard
                const forbidden = ["ignore previous", "system prompt", "jailbreak"];
                if (forbidden.some(f => textToSend.toLowerCase().includes(f))) {
                   setMessages(prev => [...prev, { role: 'system', text: "⚠️ **Security Alert:** Possible prompt injection detected." }]);
                }

                const userMsg = {
                    role: 'user',
                    text: textToSend,
                    file: uploadedFile,
                    timestamp: Date.now()
                };

                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setUploadedFile(null);
                setIsLoading(true);

                // Build History
                const history = messages.filter(m => m.role !== 'system').map(m => {
                    const parts = [{ text: m.text }];
                    if (m.file) {
                        if (m.file.type.startsWith('image')) {
                            parts.push({ inlineData: { mimeType: m.file.type, data: m.file.base64.split(',')[1] } });
                        } else {
                            parts[0].text = `[File: ${m.file.name}]\n${m.file.content || '(Binary File)'}\n\n${m.text}`;
                        }
                    }
                    return { role: m.role === 'user' ? 'user' : 'model', parts };
                });

                const currentParts = [{ text: userMsg.text }];
                if (userMsg.file) {
                    if(userMsg.file.type.startsWith('image')) {
                        currentParts.push({ inlineData: { mimeType: userMsg.file.type, data: userMsg.file.base64.split(',')[1] } });
                    } else if (userMsg.file.type.startsWith('text') || userMsg.file.name.endsWith('.js') || userMsg.file.name.endsWith('.py')) {
                        currentParts[0].text = `[File: ${userMsg.file.name}]\n${userMsg.file.content}\n\n${userMsg.text}`;
                    } else {
                        currentParts[0].text = `[Attached Media: ${userMsg.file.name}]\n\n${userMsg.text}`;
                    }
                }
                history.push({ role: 'user', parts: currentParts });

                try {
                    const apiModelId = MODELS[currentModel].apiModel;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${apiModelId}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: history,
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });

                    if (!response.ok) throw new Error((await response.json()).error?.message || response.statusText);

                    const data = await response.json();
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
                    
                    addAiMessage(aiText); 

                } catch (error) {
                    setMessages(prev => [...prev, { role: 'model', text: `**Error:** ${error.message}`, isError: true }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const isImage = file.type.startsWith('image/');
                    const isVideo = file.type.startsWith('video/');
                    const isText = file.type.startsWith('text/') || ['.js','.py','.html','.css','.json','.md','.txt'].some(ext => file.name.endsWith(ext));
                    
                    let fileObj = { name: file.name, type: file.type, base64: ev.target.result, isImage, isVideo, isText };
                    
                    if (isText) {
                         const textReader = new FileReader();
                         textReader.onload = (te) => {
                             fileObj.content = te.target.result;
                             setUploadedFile(fileObj);
                         };
                         textReader.readAsText(file);
                    } else {
                         setUploadedFile(fileObj);
                    }
                };
                reader.readAsDataURL(file);
                e.target.value = null;
            };

            const handleAction = (action, text) => {
                if (action === 'copy') navigator.clipboard.writeText(text);
                if (action === 'continue') handleSendMessage("Please continue.");
                if (action === 'simple') handleSendMessage("Explain that simply.");
            };

            const openCoffeeLink = () => {
                window.open("https://buymeacoffee.com/", "_blank");
            };

            // --- Render ---

            const addAiMessage = (text, sources = [], image = null) => {
                 setMessages(prev => {
                    const newMsg = {
                        role: 'model',
                        text: text, 
                        // REMOVED: isStreaming: true - Directly render content to avoid redraws
                        timestamp: Date.now()
                    };
                    return [...prev, newMsg];
                });
            };

            const renderMessage = (msg, index) => {
                const isUser = msg.role === 'user';
                const isSystem = msg.role === 'system';
                
                if (isSystem) return (
                    <div key={index} className="flex justify-center my-4 animate-fade-in">
                         <div className="bg-yellow-900/20 border border-yellow-500/30 text-yellow-200 text-xs px-3 py-1 rounded-full flex items-center gap-2 backdrop-blur-sm">
                             <Icon icon={Icons.ShieldAlert} size={12} /> <MarkdownRenderer content={msg.text} />
                         </div>
                    </div>
                );

                return (
                    <div key={index} className={`flex gap-3 sm:gap-4 ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in group mb-6 relative`}>
                        {!isUser && (
                            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-aura-500 to-indigo-600 flex-shrink-0 flex items-center justify-center text-xs font-bold shadow-lg shadow-aura-500/20 mt-1">A</div>
                        )}
                        
                        <div className={`max-w-[88%] lg:max-w-[70%] flex flex-col ${isUser ? 'items-end' : 'items-start'}`}>
                             {msg.file && (
                                <div className="mb-2 bg-gray-800/60 border border-gray-700/50 rounded-xl p-2.5 flex items-center gap-3 text-xs text-gray-300 max-w-full backdrop-blur-md">
                                    <div className="bg-gray-700/50 p-2 rounded-lg">
                                        <Icon icon={msg.file.isImage ? Icons.Image : msg.file.isVideo ? Icons.Video : Icons.FileText} size={16} className="text-aura-400" />
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <p className="truncate font-medium">{msg.file.name}</p>
                                        <p className="text-gray-500 text-[10px] uppercase">{msg.file.type.split('/')[1] || 'FILE'}</p>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {msg.file.isImage && <img src={msg.file.base64} className="h-10 w-10 rounded-lg object-cover border border-gray-700 cursor-zoom-in" onClick={() => setImageModalSrc(msg.file.base64)} />}
                                        {(msg.file.isImage || msg.file.isText || msg.file.type === 'application/pdf') && (
                                            <button 
                                                onClick={() => msg.file.isImage ? setImageModalSrc(msg.file.base64) : setFileContentModal(msg.file)}
                                                className="p-1.5 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition-colors"
                                                title="View File"
                                            >
                                                <Icon icon={Icons.Eye} size={16} />
                                            </button>
                                        )}
                                    </div>
                                </div>
                             )}

                             {msg.file && msg.file.isImage && (
                                <div className="mb-3">
                                    <img 
                                        src={msg.file.base64} 
                                        alt="Uploaded Image" 
                                        className="rounded-xl border border-gray-700/50 shadow-lg max-h-[400px] w-auto object-contain cursor-zoom-in hover:opacity-95 transition-opacity"
                                        onClick={() => setImageModalSrc(msg.file.base64)}
                                    />
                                </div>
                             )}

                            <div className={`
                                relative px-4 py-3 sm:px-5 sm:py-4 rounded-2xl shadow-sm text-sm sm:text-base transition-all duration-200
                                ${isUser 
                                    ? 'bg-gradient-to-br from-aura-600 to-indigo-600 text-white rounded-br-sm shadow-aura-500/10' 
                                    : 'glass-panel text-gray-100 rounded-tl-sm hover:shadow-lg hover:shadow-black/20'
                                }
                            `}>
                                <MarkdownRenderer content={msg.text} />
                            </div>
                            
                            {!isUser && !msg.isError && (
                                <div className="flex gap-2 mt-1.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 px-1">
                                    {['Copy', 'Continue', 'Simple'].map(action => (
                                        <button 
                                            key={action}
                                            onClick={() => handleAction(action.toLowerCase(), msg.text)}
                                            className="text-[10px] text-gray-500 hover:text-aura-400 transition-colors uppercase font-bold tracking-wider"
                                        >
                                            {action}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex h-screen bg-gray-950 text-gray-100 font-sans selection:bg-aura-500/30 overflow-hidden">
                    {/* Sidebar */}
                    <div className={`fixed inset-0 bg-black/80 z-40 lg:hidden transition-opacity duration-300 backdrop-blur-sm ${sidebarOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={() => setSidebarOpen(false)} />
                    <aside className={`fixed top-0 left-0 h-full w-72 glass-panel border-r-0 border-r-white/5 z-50 transform transition-transform duration-300 lg:relative lg:translate-x-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                         <div className="p-5 flex flex-col h-full">
                            <button onClick={startNewChat} className="w-full py-3.5 bg-gradient-to-r from-aura-600 to-indigo-600 hover:from-aura-500 hover:to-indigo-500 text-white rounded-xl font-bold shadow-lg shadow-aura-600/20 flex items-center justify-center gap-2 mb-8 transition-all hover:scale-[1.02] active:scale-[0.98]">
                                <Icon icon={Icons.Plus} size={18} /> New Chat
                            </button>
                            
                            <div className="flex-1 overflow-y-auto space-y-2 mobile-hide-scrollbar pr-1">
                                <h3 className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 pl-2">Recent History</h3>
                                {savedChats.map((c, i) => (
                                    <div key={c.id} onClick={() => loadChat(c)} className={`p-3 rounded-lg hover:bg-white/5 cursor-pointer text-sm truncate transition-colors border border-transparent hover:border-white/5 ${currentChatId === c.id ? 'bg-white/10 text-white font-medium border-white/10' : 'text-gray-400'}`}>
                                        {c.name}
                                    </div>
                                ))}
                            </div>
                            
                            <div className="mt-auto pt-4 border-t border-white/10 flex flex-col gap-3">
                                {/* Buy Me a Coffee Button */}
                                {showCoffee && (
                                    <div className="relative group">
                                        <button 
                                            onClick={openCoffeeLink}
                                            className="w-full py-2 bg-[#FFDD00] hover:bg-[#FFDD00]/90 text-black rounded-lg font-bold text-sm flex items-center justify-center gap-2 transition-colors shadow-lg shadow-yellow-500/10"
                                        >
                                            <Icon icon={Icons.Coffee} size={16} /> Buy Me a Coffee
                                        </button>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); setShowCoffee(false); }}
                                            className="absolute -top-2 -right-2 bg-gray-800 text-gray-400 hover:text-white p-1 rounded-full border border-white/10 opacity-0 group-hover:opacity-100 transition-opacity"
                                            title="Hide"
                                        >
                                            <Icon icon={Icons.X} size={10} />
                                        </button>
                                    </div>
                                )}

                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 flex items-center justify-center text-xs font-bold text-white shadow-inner">
                                            {userName ? userName[0] : 'U'}
                                        </div>
                                        <span className="text-sm font-medium text-gray-300">{userName || 'User'}</span>
                                    </div>
                                    <button onClick={() => setShowSettingsModal(true)} className="p-2 text-gray-500 hover:text-white hover:bg-white/10 rounded-lg transition-colors"><Icon icon={Icons.Settings} size={18} /></button>
                                </div>
                            </div>
                         </div>
                    </aside>

                    <main className="flex-1 flex flex-col min-w-0 relative bg-[#030712]">
                        {/* Modern Header */}
                        <header className="h-16 border-b border-white/5 bg-gray-950/80 backdrop-blur-xl flex items-center justify-between px-6 sticky top-0 z-30">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setSidebarOpen(true)} className="lg:hidden text-gray-400 hover:text-white"><Icon icon={Icons.Menu} /></button>
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-aura-500 via-indigo-400 to-cyan-400 tracking-tight">Aura v2</h1>
                            </div>
                            
                            <div className="flex items-center gap-4">
                                {/* Segmented Model Selector */}
                                <div className="flex bg-gray-900/80 p-1 rounded-lg border border-white/10">
                                    {Object.values(MODELS).map(m => (
                                        <button 
                                            key={m.id}
                                            onClick={() => setCurrentModel(m.id)}
                                            className={`px-3 py-1.5 rounded-md text-xs font-medium flex items-center gap-2 transition-all ${currentModel === m.id ? 'bg-gray-800 text-white shadow-sm border border-white/5' : 'text-gray-500 hover:text-gray-300'}`}
                                        >
                                            <Icon icon={m.icon} size={14} />
                                            <span className="hidden sm:inline">{m.name.replace('Aura ', '')}</span>
                                        </button>
                                    ))}
                                </div>

                                {/* Dedicated Dev Mode Button */}
                                <button 
                                    onClick={toggleDevMode} 
                                    className={`p-2 rounded-lg transition-all ${devMode ? 'text-aura-400 bg-aura-500/10' : 'text-gray-500 hover:text-gray-300 hover:bg-white/5'}`}
                                    title="Developer Mode"
                                >
                                    <Icon icon={Icons.Wrench} size={18} />
                                </button>
                            </div>
                        </header>

                        {/* Chat Area */}
                        <div className="flex-1 overflow-y-auto p-4 sm:p-6 pb-60 scroll-smooth mobile-hide-scrollbar">
                            {messages.length === 0 && (
                                <div className="h-full flex flex-col items-center justify-center text-center p-8 opacity-0 animate-fade-in" style={{animationDelay: '0.1s', opacity: 1}}>
                                    <div className="w-24 h-24 rounded-3xl bg-gradient-to-tr from-aura-600/20 to-indigo-600/20 mb-8 shadow-2xl shadow-aura-500/10 flex items-center justify-center border border-white/5 backdrop-blur-md">
                                        <Icon icon={Icons.Zap} size={48} className="text-aura-400 drop-shadow-[0_0_15px_rgba(139,92,246,0.5)]" />
                                    </div>
                                    <h2 className="text-3xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-500">Welcome to Aura</h2>
                                    <p className="text-gray-500 text-sm max-w-sm leading-relaxed">
                                        Your advanced AI workspace. Secure, powerful, and designed for speed.
                                    </p>
                                </div>
                            )}
                            {messages.map(renderMessage)}
                            {isLoading && (
                                <div className="flex gap-3 animate-fade-in pl-2">
                                     <div className="w-8 h-8 rounded-lg bg-gray-900/50 border border-white/5 flex items-center justify-center"><div className="w-1.5 h-1.5 bg-aura-500 rounded-full animate-pulse" /></div>
                                </div>
                            )}
                            
                            <div ref={messagesEndRef} className="h-24 w-full block" />
                        </div>

                        {/* Floating Tool Dock & Input */}
                        <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-[#030712] via-[#030712] to-transparent z-20">
                            <div className="max-w-3xl mx-auto flex flex-col gap-3">
                                
                                {/* Input Box */}
                                <div className="glass-input rounded-2xl p-2 shadow-2xl relative border border-white/10 group focus-within:border-aura-500/50 transition-colors">
                                    {uploadedFile && (
                                        <div className="absolute -top-16 left-0 bg-gray-900/95 border border-white/10 rounded-xl p-2 flex items-center gap-3 text-xs shadow-xl animate-scale-in backdrop-blur-md z-30">
                                            {uploadedFile.isImage 
                                                ? <img src={uploadedFile.base64} className="w-10 h-10 rounded object-cover cursor-pointer" onClick={() => setImageModalSrc(uploadedFile.base64)} />
                                                : <div className="bg-gray-800 p-2 rounded-lg"><Icon icon={uploadedFile.isVideo ? Icons.Video : Icons.FileText} size={20} className="text-aura-400" /></div>
                                            }
                                            <div className="flex flex-col">
                                                <span className="max-w-[150px] truncate font-medium">{uploadedFile.name}</span>
                                                <span className="text-[10px] text-gray-500 uppercase">Ready to send</span>
                                            </div>
                                            <button onClick={() => setUploadedFile(null)} className="hover:text-red-400 ml-2"><Icon icon={Icons.X} size={14} /></button>
                                        </div>
                                    )}
                                    {/* CHANGED: items-end -> items-center for vertical alignment */}
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => fileInputRef.current.click()} className="p-3 text-gray-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors">
                                            <Icon icon={Icons.Plus} size={20} />
                                        </button>
                                        <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileUpload} accept="image/*,video/*,text/*,.pdf,.js,.py,.html,.css,.json" />
                                        
                                        <textarea
                                            value={input}
                                            onChange={(e) => setInput(e.target.value)}
                                            onKeyDown={(e) => { 
                                                if (e.key === 'Enter' && !e.shiftKey) { 
                                                    e.preventDefault(); 
                                                    // Only send if NOT loading
                                                    if (!isLoading) handleSendMessage(); 
                                                } 
                                            }}
                                            placeholder="Ask anything..."
                                            className="flex-1 bg-transparent border-none outline-none text-gray-100 placeholder-gray-600 resize-none py-3.5 max-h-32 min-h-[48px] text-sm sm:text-base"
                                            rows={1}
                                            onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }}
                                        />
                                        
                                        <button 
                                            onClick={() => handleSendMessage()}
                                            disabled={isLoading || (!input.trim() && !uploadedFile)}
                                            className={`p-3 rounded-xl transition-all duration-300 ${input.trim() || uploadedFile ? 'bg-gradient-to-r from-aura-600 to-indigo-600 text-white shadow-lg shadow-aura-600/20 scale-100' : 'bg-gray-800/50 text-gray-600 scale-95'}`}
                                        >
                                            <Icon icon={Icons.Send} size={20} />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    {/* Modals */}
                    <Modal isOpen={showSettingsModal} onClose={() => apiKey && setShowSettingsModal(false)} title="System Settings">
                        <div className="space-y-6">
                            <div className="bg-gray-900/50 p-4 rounded-xl border border-white/5">
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 block">Gemini API Key</label>
                                <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full bg-black/20 border border-white/10 rounded-lg p-3 text-white focus:border-aura-500 outline-none transition-colors" placeholder="Paste your key here..." />
                            </div>
                            
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase tracking-widest mb-2 block">Data Privacy</label>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    {['local', 'session'].map(mode => (
                                        <button 
                                            key={mode}
                                            onClick={() => setStorageMode(mode)} 
                                            className={`p-3 rounded-xl border text-xs font-bold uppercase tracking-wider transition-all ${storageMode === mode ? 'bg-aura-600/20 border-aura-500 text-aura-300' : 'border-white/5 bg-white/5 text-gray-400 hover:bg-white/10'}`}
                                        >
                                            {mode === 'local' ? 'Local' : 'Session'}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Dev Mode Panel (When Active) */}
                            {devMode && (
                                <div className="animate-fade-in bg-aura-900/10 p-4 rounded-xl border border-aura-500/20 space-y-4">
                                    <div className="flex items-center gap-2 text-aura-400 mb-2">
                                        <Icon icon={Icons.Wrench} size={14} />
                                        <span className="text-xs font-bold uppercase tracking-wider">Developer Config</span>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-1 block">System Prompt</label>
                                        <textarea value={systemPrompt} onChange={e => setSystemPrompt(e.target.value)} className="w-full bg-black/20 border border-white/10 rounded-lg p-2 text-xs text-gray-300 h-20 resize-none outline-none focus:border-aura-500 font-mono"></textarea>
                                    </div>
                                </div>
                            )}

                            <button onClick={() => setShowSettingsModal(false)} className="w-full py-3.5 bg-white text-black hover:bg-gray-200 rounded-xl font-bold transition-colors">Save Changes</button>
                        </div>
                    </Modal>

                    <Modal isOpen={showPasskeyModal} onClose={() => setShowPasskeyModal(false)} title="Developer Access">
                         <div className="space-y-4">
                            <p className="text-sm text-gray-400">Enter the passkey to unlock Developer Mode.</p>
                            <input 
                                type="password" 
                                value={passkeyInput} 
                                onChange={(e) => setPasskeyInput(e.target.value)} 
                                className="w-full bg-gray-900/50 border border-white/10 rounded-lg p-3 text-white focus:border-aura-500 outline-none" 
                                placeholder="Passkey"
                                onKeyDown={(e) => e.key === 'Enter' && submitPasskey()}
                            />
                            <button onClick={submitPasskey} className="w-full py-3 bg-aura-600 hover:bg-aura-500 text-white rounded-xl font-bold transition-colors">Unlock</button>
                         </div>
                    </Modal>

                    {/* NEW: Improved Image Modal */}
                    {imageModalSrc && (
                        <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/95 backdrop-blur-xl p-4 animate-fade-in" onClick={() => setImageModalSrc(null)}>
                            <img 
                                src={imageModalSrc} 
                                alt="Full view" 
                                className="max-w-[90vw] max-h-[85vh] rounded-xl shadow-2xl object-contain cursor-zoom-out" 
                            />
                            <div className="absolute bottom-6 flex gap-4">
                                <a href={imageModalSrc} download="aura-image.png" className="px-6 py-2 bg-white text-black rounded-full font-bold shadow-lg hover:bg-gray-200 transition-colors" onClick={e => e.stopPropagation()}>
                                    Download
                                </a>
                                <button className="px-6 py-2 bg-gray-800 text-white rounded-full font-bold shadow-lg hover:bg-gray-700 transition-colors border border-white/10" onClick={() => setImageModalSrc(null)}>
                                    Close
                                </button>
                            </div>
                        </div>
                    )}

                    {/* NEW: File Content Modal (Text) */}
                    {fileContentModal && (
                        <Modal isOpen={!!fileContentModal} onClose={() => setFileContentModal(null)} title={fileContentModal.name}>
                            <pre className="text-xs text-gray-300 font-mono whitespace-pre-wrap break-all bg-black/20 p-4 rounded-lg border border-white/5">
                                {fileContentModal.content}
                            </pre>
                        </Modal>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
